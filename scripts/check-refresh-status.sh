#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/check-refresh-status.sh

LOG_FILE="/tmp/refresh-all-cache.log"

if [ ! -f "$LOG_FILE" ]; then
    echo "‚ùå –õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ –∑–∞–ø—É—â–µ–Ω."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
if pgrep -f "refresh-all-local-plans" > /dev/null; then
    echo "üîÑ –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ –í–´–ü–û–õ–ù–Ø–ï–¢–°–Ø..."
    echo ""
else
    echo "‚úÖ –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ –ó–ê–í–ï–†–®–ï–ù (–∏–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω)"
    echo ""
fi

# –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
if grep -q "–ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã" "$LOG_FILE"; then
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo "üìä –§–ò–ù–ê–õ–¨–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    grep -A 10 "–ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã" "$LOG_FILE" | tail -10
    echo ""
    echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
else
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
    last_progress=$(grep -oE "\[[0-9]+/196" "$LOG_FILE" | tail -1)
    if [ -n "$last_progress" ]; then
        current=$(echo "$last_progress" | grep -oE "[0-9]+" | head -1)
        total=196
        percent=$((current * 100 / total))
        remaining=$((total - current))
        
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üìä –¢–ï–ö–£–©–ò–ô –ü–†–û–ì–†–ï–°–°:"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "   –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: $current –∏–∑ $total —Å—Ç—Ä–∞–Ω ($percent%)"
        echo "   –û—Å—Ç–∞–ª–æ—Å—å: ~$remaining —Å—Ç—Ä–∞–Ω"
        echo ""
        
        # –û—Ü–µ–Ω–∏–≤–∞–µ–º –≤—Ä–µ–º—è
        if [ $current -gt 0 ]; then
            # –ü—Ä–∏–º–µ—Ä–Ω–æ 0.3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Å—Ç—Ä–∞–Ω—É + –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
            estimated_seconds=$((remaining * 1))
            estimated_minutes=$((estimated_seconds / 60))
            estimated_secs=$((estimated_seconds % 60))
            
            if [ $estimated_minutes -gt 0 ]; then
                echo "   ‚è±Ô∏è  –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: ~${estimated_minutes} –º–∏–Ω ${estimated_secs} —Å–µ–∫"
            else
                echo "   ‚è±Ô∏è  –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: ~${estimated_seconds} —Å–µ–∫"
            fi
        fi
        echo ""
    fi
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã
    echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã:"
    grep -E "‚úÖ.*\([A-Z]{2,5}\)" "$LOG_FILE" | tail -5 | sed 's/^/   /'
    echo ""
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    success_count=$(grep -c "‚úÖ.*standard.*unlimited" "$LOG_FILE" 2>/dev/null || echo "0")
    failed_count=$(grep -c "‚ùå" "$LOG_FILE" 2>/dev/null || echo "0")
    skipped_count=$(grep -c "‚ö†Ô∏è.*—Ç–∞—Ä–∏—Ñ—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" "$LOG_FILE" 2>/dev/null || echo "0")
    
    echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
    echo "   ‚úÖ –£—Å–ø–µ—à–Ω–æ: $success_count"
    echo "   ‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: $skipped_count"
    echo "   ‚ùå –û—à–∏–±–∫–∏: $failed_count"
    echo ""
    
    if pgrep -f "refresh-all-local-plans" > /dev/null; then
        echo "üí° –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏: tail -f $LOG_FILE"
    fi
fi

