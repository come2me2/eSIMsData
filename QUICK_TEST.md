# Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð² Ð·Ð°ÐºÐ°Ð·Ð¾Ð²

## ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

### 1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ñ‚ÐµÑÑ‚
```bash
node scripts/test-order-statuses.js
```

Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚:
- âœ… Ð’ÑÐµ Ð·Ð°ÐºÐ°Ð·Ñ‹ Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿Ð¾Ð»ÐµÐ¹
- âœ… Ð›Ð¾Ð³Ð¸ÐºÑƒ ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð² (completed Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¸Ð¼ÐµÑ‚ÑŒ eSIM, on_hold Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¸Ð¼ÐµÑ‚ÑŒ expires_at Ð¸ Ñ‚.Ð´.)
- âœ… Ð˜ÑÑ‚ÐµÐºÑˆÐ¸Ðµ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹
- âœ… Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð¿Ð¾ Ð²ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°Ð¼

### 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
```bash
node scripts/check-order-timeouts.js
```

### 3. Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· Telegram Mini App

#### Ð¨Ð°Ð³ 1: Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ invoice
1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Telegram Mini App
2. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð»Ð°Ð½ eSIM
3. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "Buy with Stars"
4. **ÐÐ• Ð¾Ð¿Ð»Ð°Ñ‡Ð¸Ð²Ð°Ð¹Ñ‚Ðµ** invoice ÑÑ€Ð°Ð·Ñƒ

#### Ð¨Ð°Ð³ 2: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð·Ð°ÐºÐ°Ð· Ð² Ð°Ð´Ð¼Ð¸Ð½ÐºÐµ
1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð°Ð´Ð¼Ð¸Ð½ÐºÑƒ â†’ Orders
2. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð·Ð°ÐºÐ°Ð· ÑÐ¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð¼ `on_hold`
3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:
   - âœ… Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: `on_hold`
   - âœ… `expires_at` ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ (Ñ‡ÐµÑ€ÐµÐ· 5 Ð¼Ð¸Ð½ÑƒÑ‚)
   - âœ… `payment_status: "pending"`
   - âœ… `payment_confirmed: false`

#### Ð¨Ð°Ð³ 3: ÐžÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚Ðµ invoice
1. Ð’ÐµÑ€Ð½Ð¸Ñ‚ÐµÑÑŒ Ð² Telegram Mini App
2. ÐžÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚Ðµ invoice

#### Ð¨Ð°Ð³ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ð°
1. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Orders Ð² Ð°Ð´Ð¼Ð¸Ð½ÐºÐµ
2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:
   - âœ… Ð•ÑÐ»Ð¸ eSIM Ð²Ñ‹Ð´Ð°Ð½Ð°: `status: "completed"`, `esim_issued: true`
   - âœ… Ð•ÑÐ»Ð¸ eSIM Ð½Ðµ Ð²Ñ‹Ð´Ð°Ð½Ð°: `status: "on_hold"`, `esim_issued: false`
   - âœ… `payment_status: "succeeded"`
   - âœ… `payment_confirmed: true`
   - âœ… `expires_at: null`

### 4. Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð°

#### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð·Ð°ÐºÐ°Ð· Ð¸ Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ 5+ Ð¼Ð¸Ð½ÑƒÑ‚
1. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ invoice, Ð½Ð¾ ÐÐ• Ð¾Ð¿Ð»Ð°Ñ‡Ð¸Ð²Ð°Ð¹Ñ‚Ðµ
2. ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ 5+ Ð¼Ð¸Ð½ÑƒÑ‚
3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: `node scripts/check-order-timeouts.js`
4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ: Ð·Ð°ÐºÐ°Ð· Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ `canceled`

#### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: Ð’Ñ€ÑƒÑ‡Ð½ÑƒÑŽ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ expires_at Ð² Ð¿Ñ€Ð¾ÑˆÐ»Ð¾Ðµ
```bash
# ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ data/orders.json
# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ expires_at Ð½Ð° Ð²Ñ€ÐµÐ¼Ñ Ð² Ð¿Ñ€Ð¾ÑˆÐ»Ð¾Ð¼
# Ð—Ð°Ñ‚ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ:
node scripts/check-order-timeouts.js
```

### 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Ñ„Ð°Ð¹Ð» Ð·Ð°ÐºÐ°Ð·Ð¾Ð²
```bash
# ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð²ÑÐµÑ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð²
cat data/orders.json | jq '.'

# ÐŸÐ¾Ð¸ÑÐº Ð·Ð°ÐºÐ°Ð·Ð¾Ð² on_hold
cat data/orders.json | jq '.[] | .[] | select(.status == "on_hold")'

# ÐŸÐ¾Ð¸ÑÐº Ð·Ð°ÐºÐ°Ð·Ð¾Ð² Ñ Ð¸ÑÑ‚ÐµÐºÑˆÐ¸Ð¼ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð¾Ð¼
node -e "
const fs = require('fs');
const orders = JSON.parse(fs.readFileSync('data/orders.json', 'utf8'));
const now = new Date();
for (const userId in orders) {
  orders[userId].forEach(order => {
    if (order.status === 'on_hold' && order.expires_at) {
      const expires = new Date(order.expires_at);
      if (expires < now) {
        console.log('Expired:', order.orderReference, 'expired at', order.expires_at);
      }
    }
  });
}
"
```

## ðŸ“‹ Ð§ÐµÐºÐ»Ð¸ÑÑ‚ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð°

- [ ] Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ `node scripts/test-order-statuses.js` - Ð²ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¿Ñ€Ð¾Ð¹Ñ‚Ð¸
- [ ] Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ invoice Ñ‡ÐµÑ€ÐµÐ· Telegram Mini App
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð· `on_hold` Ð² Ð°Ð´Ð¼Ð¸Ð½ÐºÐµ
- [ ] ÐžÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ invoice
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ð° (ÑÑ‚Ð°Ñ‚ÑƒÑ Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÑ‚Ð°Ñ‚ÑŒ `completed` Ð¸Ð»Ð¸ Ð¾ÑÑ‚Ð°Ñ‚ÑŒÑÑ `on_hold` ÐµÑÐ»Ð¸ eSIM Ð½Ðµ Ð²Ñ‹Ð´Ð°Ð½Ð°)
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ UI Ð°Ð´Ð¼Ð¸Ð½ÐºÐ¸ - Ð²ÑÐµ ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÑŽÑ‚ÑÑ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾
- [ ] Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ `node scripts/check-order-timeouts.js` - Ð¸ÑÑ‚ÐµÐºÑˆÐ¸Ðµ Ð·Ð°ÐºÐ°Ð·Ñ‹ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ñ‹

## ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð²

```bash
# ÐÐ° ÑÐµÑ€Ð²ÐµÑ€Ðµ
pm2 logs esimsdata --lines 50

# Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°Ð¼
pm2 logs esimsdata | grep -E "(on_hold|completed|failed|canceled)"
```

## âš ï¸ Ð§Ð°ÑÑ‚Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹

### Ð—Ð°ÐºÐ°Ð· Ð½Ðµ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ invoice
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: `pm2 logs esimsdata`
- Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ `api/telegram/stars/create-invoice.js` Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² `data/orders.json`

### Ð—Ð°ÐºÐ°Ð· Ð½Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ webhook: `pm2 logs esimsdata | grep webhook`
- Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ webhook Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ `successful_payment`
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ñ‡Ñ‚Ð¾ Ð·Ð°ÐºÐ°Ð· `on_hold` Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ `payment_session_id`

### Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚
- Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ: `node scripts/check-order-timeouts.js`
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ñ‡Ñ‚Ð¾ `expires_at` ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð°Ñ‚Ñ‹ Ð² `expires_at` (Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ISO string)

## ðŸ“š ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ

Ð¡Ð¼. `TESTING.md` Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ.

