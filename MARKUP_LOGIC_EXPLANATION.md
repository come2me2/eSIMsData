# –õ–æ–≥–∏–∫–∞ –Ω–∞—Ü–µ–Ω–æ–∫ - –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

## üìä –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –¶–µ–Ω—ã –≤ API `/api/esimgo/plans`
```
–¶–µ–Ω–∞ –æ—Ç eSIM-GO (—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å) = $2.26
‚Üì
–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –±–∞–∑–æ–≤–∞—è –º–∞—Ä–∂–∞ –∏–∑ –∞–¥–º–∏–Ω–∫–∏ (29%) = 1.29
‚Üì
–¶–µ–Ω–∞ –Ω–∞ checkout = $2.26 √ó 1.29 = $2.92
```

**–ö–æ–¥:** `api/esimgo/plans.js` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `applyMarkup()`
- –ß–∏—Ç–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ `data/admin-settings.json`
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç `markup.base` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.29)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–µ–Ω—É —Å –±–∞–∑–æ–≤–æ–π –Ω–∞—Ü–µ–Ω–∫–æ–π

### 2. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –Ω–∞ checkout

```
–¶–µ–Ω–∞ –Ω–∞ checkout (—Å –±–∞–∑–æ–≤–æ–π –º–∞—Ä–∂–æ–π) = $2.92
‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç Telegram Stars
‚Üì
–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –º–∞—Ä–∂–∞ Stars (5%) = 1.05
‚Üì
–§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è = $2.92 √ó 1.05 = $3.07
```

**–ö–æ–¥:** `public/checkout.js` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `updateTotalPrice()`
- –ß–∏—Ç–∞–µ—Ç `paymentMethods.telegramStars.markupMultiplier` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.05)
- –£–º–Ω–æ–∂–∞–µ—Ç `originalPrice` –Ω–∞ —ç—Ç–æ—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—å
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### 3. –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ Telegram Stars

**–¢–µ–∫—É—â–∞—è —Ñ–æ—Ä–º—É–ª–∞ –≤ `api/telegram/stars/create-invoice.js`:**

```javascript
Stars = Math.ceil(
  price / (1 - STARS_MARGIN) / (1 - STARS_TELEGRAM_FEE) / STARS_RATE
)
```

**–ì–¥–µ:**
- `price` = —Ü–µ–Ω–∞, –∫–æ—Ç–æ—Ä—É—é –ø–µ—Ä–µ–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç ($3.07 —Å –æ–±–µ–∏–º–∏ –Ω–∞—Ü–µ–Ω–∫–∞–º–∏)
- `STARS_MARGIN` = 0.29 (hardcoded –≤ .env, –æ–∂–∏–¥–∞–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å!)
- `STARS_TELEGRAM_FEE` = 0.25 (–∫–æ–º–∏—Å—Å–∏—è Telegram 25%)
- `STARS_RATE` = 0.013 ($0.013 –∑–∞ 1 Star)

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

1. **–§–æ—Ä–º—É–ª–∞ –æ–∂–∏–¥–∞–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å** ($2.26), –Ω–æ –ø–æ–ª—É—á–∞–µ—Ç **—Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É —Å –æ–±–µ–∏–º–∏ –Ω–∞—Ü–µ–Ω–∫–∞–º–∏** ($3.07)
2. **STARS_MARGIN = 0.29 hardcoded** –≤–º–µ—Å—Ç–æ —á—Ç–µ–Ω–∏—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–¥–º–∏–Ω–∫–∏
3. **–§–æ—Ä–º—É–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é –º–∞—Ç–µ–º–∞—Ç–∏–∫—É**: –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ `(1 - margin)` –Ω–µ–≤–µ—Ä–Ω–æ –¥–ª—è –Ω–∞—à–∏—Ö —Ü–µ–ª–µ–π

### –ü—Ä–∏–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
```
price = $3.07 (—Å –æ–±–µ–∏–º–∏ –Ω–∞—Ü–µ–Ω–∫–∞–º–∏)
Stars = 3.07 / (1 - 0.29) / (1 - 0.25) / 0.013
Stars = 3.07 / 0.71 / 0.75 / 0.013
Stars ‚âà 443 Stars
```

–≠—Ç–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ Stars! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–ø–ª–∞—á–∏–≤–∞–µ—Ç.

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ —Ñ–æ—Ä–º—É–ª—É Stars (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `public/checkout.js`:

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–∞ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å **—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å** (cost), –∞ –Ω–µ —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É:

```javascript
// –í—ã—á–∏—Å–ª—è–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ —Ü–µ–Ω—ã –Ω–∞ checkout
const costPrice = originalPriceValue / (publicSettings.markup.base || 1.29);

const invoiceData = {
    plan_id: selectedPlan.id,
    plan_type: orderData.planType,
    bundle_name: selectedPlan.bundle_name,
    country_code: orderData.code,
    country_name: orderData.name,
    price: costPrice, // ‚Üê –°–ï–ë–ï–°–¢–û–ò–ú–û–°–¢–¨!
    currency: 'USD',
    telegram_user_id: telegramUserId,
    telegram_username: telegramUsername
};
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `api/telegram/stars/create-invoice.js`:

–ó–∞–≥—Ä—É–∂–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ü–µ–Ω–æ–∫ –∏–∑ –∞–¥–º–∏–Ω–∫–∏ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å Stars:

```javascript
// –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –∞–¥–º–∏–Ω–∫–∏
const fs = require('fs').promises;
const path = require('path');
const SETTINGS_FILE = path.join(__dirname, '..', '..', 'data', 'admin-settings.json');

async function loadSettings() {
    try {
        const data = await fs.readFile(SETTINGS_FILE, 'utf8');
        return JSON.parse(data);
    } catch (error) {
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        return {
            markup: { enabled: true, base: 1.29 },
            paymentMethods: {
                telegramStars: { enabled: true, markupMultiplier: 1.05 }
            }
        };
    }
}

// –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ:
const settings = await loadSettings();
const baseMarkup = settings.markup.base || 1.29;
const starsMarkup = settings.paymentMethods.telegramStars.markupMultiplier || 1.05;

// –§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ = —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å √ó –±–∞–∑–æ–≤–∞—è –º–∞—Ä–∂–∞ √ó –º–∞—Ä–∂–∞ Stars
const finalPrice = priceNumber * baseMarkup * starsMarkup;

// –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ Stars (–ü–†–ê–í–ò–õ–¨–ù–ê–Ø):
// Stars = (finalPrice) / (1 - telegram_fee) / stars_rate
const amountStars = Math.max(
    MIN_STARS,
    Math.ceil(
        finalPrice / (1 - STARS_TELEGRAM_FEE) / STARS_RATE
    )
);
```

### –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞:
```
–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å = $2.26
–ë–∞–∑–æ–≤–∞—è –º–∞—Ä–∂–∞ = 1.29 (29%)
–ú–∞—Ä–∂–∞ Stars = 1.05 (5%)
–ö–æ–º–∏—Å—Å–∏—è Telegram = 25%
–ö—É—Ä—Å Stars = $0.013

–§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è = $2.26 √ó 1.29 √ó 1.05 = $3.06

Stars = $3.06 / (1 - 0.25) / $0.013
Stars = $3.06 / 0.75 / $0.013
Stars ‚âà 314 Stars
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:
```
314 Stars √ó $0.013 = $4.08
–ü–æ—Å–ª–µ –∫–æ–º–∏—Å—Å–∏–∏ Telegram (25%): $4.08 √ó 0.75 = $3.06 ‚úÖ
```

–≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç 314 Stars –∏ –ø–æ–ª—É—á–∞–µ—Ç eSIM —Å –∑–∞–ª–æ–∂–µ–Ω–Ω–æ–π –º–∞—Ä–∂–æ–π.

---

## üìù –†–µ–∑—é–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 1. –í `public/checkout.js`:
- –í—ã—á–∏—Å–ª—è—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ `create-invoice`
- –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å cost –≤–º–µ—Å—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã

### 2. –í `api/telegram/stars/create-invoice.js`:
- –ó–∞–≥—Ä—É–∂–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ `data/admin-settings.json`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `baseMarkup` –∏ `starsMarkup` –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–æ—Ä–º—É–ª—É: `Stars = (cost √ó baseMarkup √ó starsMarkup) / (1 - telegram_fee) / stars_rate`

### 3. –£–¥–∞–ª–∏—Ç—å hardcoded –∑–Ω–∞—á–µ–Ω–∏—è:
- –£–±—Ä–∞—Ç—å `STARS_MARGIN` –∏–∑ .env
- –ß–∏—Ç–∞—Ç—å –≤—Å–µ –Ω–∞—Ü–µ–Ω–∫–∏ –∏–∑ –∞–¥–º–∏–Ω–∫–∏

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

1. ‚úÖ **–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã**: –≤—Å–µ –Ω–∞—Ü–µ–Ω–∫–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
2. ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å**: –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –Ω–∞—Ü–µ–Ω–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
3. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç —Ä–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ, —Å–∫–æ–ª—å–∫–æ –º—ã —Ö–æ—Ç–∏–º
4. ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å**: –Ω–∞ checkout –≤–∏–¥–Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –î–û –æ–ø–ª–∞—Ç—ã

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –¶–µ–Ω–∞ –Ω–∞ checkout —Å—Ç—Ä–∞–Ω–∏—Ü–µ:
- **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è**: —Ü–µ–Ω–∞ —Å –±–∞–∑–æ–≤–æ–π –º–∞—Ä–∂–æ–π + –º–∞—Ä–∂–µ–π —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
- **–ù–∞–ø—Ä–∏–º–µ—Ä**: $2.26 √ó 1.29 √ó 1.05 = $3.06

### –§–æ—Ä–º—É–ª–∞ Stars:
- **–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢** –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ `(1 - margin)` - —ç—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞!
- **–ò–°–ü–û–õ–¨–ó–£–ï–¢** –ø—Ä–æ—Å—Ç–æ–µ —É–º–Ω–æ–∂–µ–Ω–∏–µ: `cost √ó baseMarkup √ó starsMarkup`
- –ó–∞—Ç–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ Stars —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏ Telegram

### –î–ª—è –¥—Ä—É–≥–∏—Ö —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã (Cryptomus, Stripe):
- –¢–∞ –∂–µ –ª–æ–≥–∏–∫–∞
- –§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ = cost √ó baseMarkup √ó paymentMethodMarkup
- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤ –ø–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä

