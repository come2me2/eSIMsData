# üí≥ –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Cryptomus –¥–ª—è –æ–ø–ª–∞—Ç—ã eSIM –∏ Extend

## üìã –û–±–∑–æ—Ä

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Cryptomus –ø–æ–∑–≤–æ–ª–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ–ø–ª–∞—á–∏–≤–∞—Ç—å eSIM –∏ –¥–æ–∫—É–ø–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫ (extend) —á–µ—Ä–µ–∑ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å Telegram Stars –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤—Å–µ —Ç–µ –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏.

---

## üéØ –¶–µ–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

1. ‚úÖ –ü–æ–∑–≤–æ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ–ø–ª–∞—á–∏–≤–∞—Ç—å eSIM —á–µ—Ä–µ–∑ Cryptomus (–∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏)
2. ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª Extend (–¥–æ–∫—É–ø–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞) —á–µ—Ä–µ–∑ Cryptomus
3. ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π Telegram Stars
4. ‚úÖ –û–±–µ—Å–ø–µ—á–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–ª–∞—Ç–µ–∂–µ–π
5. ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –≤—Å–µ –Ω–∞—Ü–µ–Ω–∫–∏ –∏ —Ä–∞—Å—á–µ—Ç—ã —Ü–µ–Ω (–∫–∞–∫ –≤ Telegram Stars)

---

## üìö –≠—Ç–∞–ø 1: –ò–∑—É—á–µ–Ω–∏–µ Cryptomus API

### 1.1 –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã Cryptomus API

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: https://doc.cryptomus.com/

#### –°–æ–∑–¥–∞–Ω–∏–µ Invoice
- **Endpoint**: `POST https://api.cryptomus.com/v1/payment`
- **–ú–µ—Ç–æ–¥**: `createInvoice`
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
  - `amount` - —Å—É–º–º–∞ –≤ —Ñ–∏–∞—Ç–Ω–æ–π –≤–∞–ª—é—Ç–µ (USD)
  - `currency` - –≤–∞–ª—é—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ (USD)
  - `order_id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–∫–∞–∑–∞
  - `url_callback` - URL –¥–ª—è webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  - `url_return` - URL –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
  - `to_currency` - –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã (USDT, BTC, ETH –∏ —Ç.–¥.)
  - `network` - —Å–µ—Ç—å –±–ª–æ–∫—á–µ–π–Ω–∞ (tron, ethereum, bitcoin –∏ —Ç.–¥.)
  - `lifetime` - –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∏–Ω–≤–æ–π—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3600)

#### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
- **Endpoint**: `GET https://api.cryptomus.com/v1/payment/{uuid}`
- **–ú–µ—Ç–æ–¥**: `getPaymentInfo`

#### Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **URL**: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ `url_callback` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ invoice
- **–ú–µ—Ç–æ–¥**: `POST` —Å JSON —Ç–µ–ª–æ–º
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏**: MD5(base64(JSON –±–µ–∑ –ø–æ–ª—è sign) + API_PAYMENT_KEY)

### 1.2 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö Cryptomus

#### –ó–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω–∏—è invoice:
```json
{
  "amount": "25.00",
  "currency": "USD",
  "order_id": "esim_order_12345",
  "url_callback": "https://yourdomain.com/api/cryptomus/webhook",
  "url_return": "https://yourdomain.com/checkout?order_id=esim_order_12345",
  "to_currency": "USDT",
  "network": "tron",
  "lifetime": 3600
}
```

#### –û—Ç–≤–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—è invoice:
```json
{
  "state": 0,
  "result": {
    "uuid": "invoice-uuid-here",
    "order_id": "esim_order_12345",
    "amount": "25.00",
    "currency": "USD",
    "merchant_amount": "24.80",
    "network": "tron",
    "address": "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t",
    "from": null,
    "txid": null,
    "payment_status": "waiting",
    "url": "https://pay.cryptomus.com/pay/invoice-uuid-here",
    "expired_at": 1234567890,
    "status": "process",
    "is_final": false,
    "network": "tron",
    "payer_currency": "USDT"
  }
}
```

#### Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
```json
{
  "type": "payment",
  "uuid": "invoice-uuid-here",
  "order_id": "esim_order_12345",
  "amount": "25.00",
  "payment_amount": "25.00",
  "merchant_amount": "24.80",
  "commission": "0.20",
  "status": "paid",
  "is_final": true,
  "currency": "USD",
  "payer_currency": "USDT",
  "network": "tron",
  "from": "wallet_address",
  "txid": "transaction_hash",
  "sign": "hash-signature"
}
```

---

## üîÑ –≠—Ç–∞–ø 2: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram Stars

### 2.1 –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Telegram Stars

1. **–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞**: `api/telegram/stars/create-invoice.js`
   - –†–∞—Å—á–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã —Å –Ω–∞—Ü–µ–Ω–∫–∞–º–∏
   - –°–æ–∑–¥–∞–Ω–∏–µ payload —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–∫–∞–∑–∞
   - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `on_hold`

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook**: `api/telegram/stars/webhook.js`
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ `pre_checkout_query`
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ `successful_payment`
   - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ eSIM Go
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
   - –û—Ç–ø—Ä–∞–≤–∫–∞ QR –∫–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

3. **Frontend**: `public/checkout.js`
   - –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
   - –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ Stars
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ Extend —Ä–µ–∂–∏–º–∞

### 2.2 –ù—é–∞–Ω—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —É—á–µ—Å—Ç—å –¥–ª—è Cryptomus

1. **–†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã**:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (cost) –æ—Ç eSIM Go
   - –ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –Ω–∞—Ü–µ–Ω–∫–∏: –±–∞–∑–æ–≤–∞—è –º–∞—Ä–∂–∞ + –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —Å—Ç—Ä–∞–Ω–µ + –Ω–∞—Ü–µ–Ω–∫–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
   - –§–æ—Ä–º—É–ª–∞: `finalPrice = cost √ó baseMarkup √ó countryMarkup √ó cryptomusMarkup`

2. **Payload –¥–ª—è –∑–∞–∫–∞–∑–∞**:
   - –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
   - –í–∫–ª—é—á–∞–µ—Ç: plan_id, plan_type, bundle_name, country_code, country_name, finalPrice, iccid (–¥–ª—è extend)

3. **Extend —Ä–µ–∂–∏–º**:
   - –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è `iccid` —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π eSIM
   - –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –≤ eSIM Go –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `iccid` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞

4. **–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–∞**:
   - `on_hold` - –∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
   - `completed` - –æ–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞, eSIM –≤—ã–¥–∞–Ω–∞
   - `failed` - –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –∏–ª–∏ –æ–ø–ª–∞—Ç–µ

5. **–¢–∞–π–º–∞—É—Ç—ã**:
   - –î–ª—è Cryptomus: 60 –º–∏–Ω—É—Ç (3600 —Å–µ–∫—É–Ω–¥)

---

## üèóÔ∏è –≠—Ç–∞–ø 3: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 3.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
api/
  cryptomus/
    create-invoice.js      # –°–æ–∑–¥–∞–Ω–∏–µ Cryptomus invoice
    webhook.js              # –û–±—Ä–∞–±–æ—Ç–∫–∞ Cryptomus webhooks
  _lib/
    cryptomus/
      client.js             # –ö–ª–∏–µ–Ω—Ç –¥–ª—è Cryptomus API
```

### 3.2 –ü–æ—Ç–æ–∫ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Cryptomus

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã "Cryptomus" –≤ checkout
2. Frontend –≤—ã–∑—ã–≤–∞–µ—Ç /api/cryptomus/create-invoice
3. Backend:
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É —Å –Ω–∞—Ü–µ–Ω–∫–∞–º–∏
   - –°–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º on_hold
   - –°–æ–∑–¥–∞–µ—Ç invoice –≤ Cryptomus API
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –¥–ª—è –æ–ø–ª–∞—Ç—ã
4. Frontend –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã Cryptomus
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π
6. Cryptomus –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ /api/cryptomus/webhook
7. Backend:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å webhook
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ (paid, is_final)
   - –°–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ –≤ eSIM Go (–∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –¥–ª—è extend)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç QR –∫–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram
```

### 3.3 –ü–æ—Ç–æ–∫ –¥–ª—è Extend —á–µ—Ä–µ–∑ Cryptomus

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "Extend" –≤ Current eSIM
2. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ checkout?extend=true&iccid=...
3. –í—ã–±–æ—Ä Cryptomus –∫–∞–∫ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
4. –°–æ–∑–¥–∞–Ω–∏–µ invoice —Å iccid –≤ order_id –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
5. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã webhook –ø–æ–ª—É—á–∞–µ—Ç order_id —Å iccid
6. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ eSIM Go —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º iccid (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞)
7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Current eSIM (—á–µ—Ä–µ–∑ api/esimgo/bundles)
```

---

## üíª –≠—Ç–∞–ø 4: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 4.1 –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤–∏—Ç—å –≤ `.env`:
```env
# Cryptomus API
CRYPTOMUS_MERCHANT_ID=your-merchant-uuid
CRYPTOMUS_API_KEY=your-payment-api-key
CRYPTOMUS_WEBHOOK_SECRET=your-webhook-secret
CRYPTOMUS_DEFAULT_CURRENCY=USDT
CRYPTOMUS_DEFAULT_NETWORK=tron
CRYPTOMUS_INVOICE_LIFETIME=3600
```

### 4.2 –ö–ª–∏–µ–Ω—Ç Cryptomus API

**–§–∞–π–ª**: `api/_lib/cryptomus/client.js`

```javascript
const crypto = require('crypto');

class CryptomusClient {
    constructor() {
        this.merchantId = process.env.CRYPTOMUS_MERCHANT_ID;
        this.apiKey = process.env.CRYPTOMUS_API_KEY;
        this.baseUrl = 'https://api.cryptomus.com/v1';
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å—å –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
     */
    generateSign(payload) {
        const payloadBase64 = Buffer.from(JSON.stringify(payload)).toString('base64');
        const sign = crypto
            .createHash('md5')
            .update(payloadBase64 + this.apiKey)
            .digest('hex');
        return sign;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç invoice –≤ Cryptomus
     */
    async createInvoice(data) {
        const payload = {
            amount: data.amount,
            currency: data.currency || 'USD',
            order_id: data.order_id,
            url_callback: data.url_callback,
            url_return: data.url_return,
            to_currency: data.to_currency || process.env.CRYPTOMUS_DEFAULT_CURRENCY || 'USDT',
            network: data.network || process.env.CRYPTOMUS_DEFAULT_NETWORK || 'tron',
            lifetime: data.lifetime || parseInt(process.env.CRYPTOMUS_INVOICE_LIFETIME || '3600')
        };

        const sign = this.generateSign(payload);

        const response = await fetch(`${this.baseUrl}/payment`, {
            method: 'POST',
            headers: {
                'merchant': this.merchantId,
                'sign': sign,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Cryptomus API error: ${response.status} ${errorText}`);
        }

        const result = await response.json();
        
        if (result.state !== 0) {
            throw new Error(`Cryptomus API error: ${result.message || 'Unknown error'}`);
        }

        return result.result;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ
     */
    async getPaymentInfo(uuid) {
        const payload = {};
        const sign = this.generateSign(payload);

        const response = await fetch(`${this.baseUrl}/payment/${uuid}`, {
            method: 'GET',
            headers: {
                'merchant': this.merchantId,
                'sign': sign
            }
        });

        if (!response.ok) {
            throw new Error(`Cryptomus API error: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.state !== 0) {
            throw new Error(`Cryptomus API error: ${result.message || 'Unknown error'}`);
        }

        return result.result;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å webhook
     */
    verifyWebhookSignature(data, signature) {
        // –£–¥–∞–ª—è–µ–º –ø–æ–ª–µ sign –∏–∑ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        const { sign, ...dataWithoutSign } = data;
        const payloadBase64 = Buffer.from(JSON.stringify(dataWithoutSign)).toString('base64');
        const expectedSign = crypto
            .createHash('md5')
            .update(payloadBase64 + this.apiKey)
            .digest('hex');
        
        return expectedSign === signature;
    }
}

module.exports = new CryptomusClient();
```

### 4.3 –°–æ–∑–¥–∞–Ω–∏–µ Invoice

**–§–∞–π–ª**: `api/cryptomus/create-invoice.js`

```javascript
const cryptomusClient = require('../_lib/cryptomus/client');
const path = require('path');
const fs = require('fs').promises;

// –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ü–µ–Ω–æ–∫
const SETTINGS_FILE = path.join(__dirname, '..', '..', 'data', 'admin-settings.json');

async function loadMarkupSettings() {
    try {
        const data = await fs.readFile(SETTINGS_FILE, 'utf8');
        return JSON.parse(data);
    } catch (error) {
        if (error.code === 'ENOENT') {
            return {
                markup: { enabled: true, base: 1.29 },
                paymentMethods: {
                    crypto: { enabled: true, markup: 1.0 }
                }
            };
        }
        throw error;
    }
}

module.exports = async function handler(req, res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') {
        return res.status(200).end();
    }

    if (req.method !== 'POST') {
        return res.status(405).json({ success: false, error: 'Method not allowed' });
    }

    try {
        const {
            plan_id,
            plan_type,
            bundle_name,
            country_code,
            country_name,
            price, // —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –æ—Ç eSIM Go
            currency = 'USD',
            telegram_user_id,
            telegram_username,
            iccid // –¥–ª—è extend mode
        } = req.body || {};

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        if (!plan_id || !plan_type || !bundle_name || !price || !telegram_user_id) {
            return res.status(400).json({
                success: false,
                error: 'Missing required fields'
            });
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ü–µ–Ω–æ–∫
        const settings = await loadMarkupSettings();
        const markup = settings.markup || {};
        const paymentMethods = settings.paymentMethods || {};

        // –†–∞—Å—á–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã (–∫–∞–∫ –≤ Telegram Stars)
        const costPrice = parseFloat(price);
        const baseMarkup = markup.enabled ? (markup.base || 1.0) : 1.0;
        
        let countryMarkup = 1.0;
        if (country_code && markup.countryMarkups && markup.countryMarkups[country_code]) {
            const countryPercent = markup.countryMarkups[country_code];
            countryMarkup = 1 + (countryPercent / 100);
        }

        const cryptoMethod = paymentMethods.crypto || {};
        const cryptomusMarkup = cryptoMethod.enabled ? (cryptoMethod.markupMultiplier || cryptoMethod.markup || 1.0) : 1.0;

        const finalPrice = costPrice * baseMarkup * countryMarkup * cryptomusMarkup;

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π order_id
        const orderId = `cryptomus_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        // –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º on_hold
        const ordersHandler = require('../orders');
        const orderReq = {
            method: 'POST',
            body: {
                telegram_user_id: telegram_user_id,
                orderReference: `pending_${orderId}`,
                status: 'on_hold',
                payment_method: 'cryptomus',
                payment_session_id: orderId,
                payment_status: 'pending',
                country_code: country_code,
                country_name: country_name,
                plan_id: plan_id,
                plan_type: plan_type,
                bundle_name: bundle_name,
                price: finalPrice,
                finalPrice: finalPrice,
                currency: currency,
                provider_base_price_usd: costPrice,
                iccid: iccid || undefined,
                expires_at: new Date(Date.now() + 60 * 60 * 1000).toISOString(), // 60 –º–∏–Ω—É—Ç
                createdAt: new Date().toISOString()
            }
        };

        const orderRes = {
            status: (code) => ({ json: (data) => {} }),
            setHeader: () => {},
            statusCode: 200
        };

        await ordersHandler(orderReq, orderRes);

        // –°–æ–∑–¥–∞–µ–º invoice –≤ Cryptomus
        const baseUrl = process.env.VERCEL_URL 
            ? `https://${process.env.VERCEL_URL}`
            : process.env.BASE_URL || 'https://yourdomain.com';

        const invoice = await cryptomusClient.createInvoice({
            amount: finalPrice.toFixed(2),
            currency: currency,
            order_id: orderId,
            url_callback: `${baseUrl}/api/cryptomus/webhook`,
            url_return: `${baseUrl}/checkout?order_id=${orderId}&payment_method=cryptomus`,
            to_currency: process.env.CRYPTOMUS_DEFAULT_CURRENCY || 'USDT',
            network: process.env.CRYPTOMUS_DEFAULT_NETWORK || 'tron',
            lifetime: parseInt(process.env.CRYPTOMUS_INVOICE_LIFETIME || '3600')
        });

        console.log('‚úÖ Cryptomus invoice created:', {
            orderId,
            invoiceUuid: invoice.uuid,
            amount: finalPrice,
            telegram_user_id
        });

        return res.status(200).json({
            success: true,
            invoiceUrl: invoice.url,
            invoiceUuid: invoice.uuid,
            orderId: orderId,
            amount: finalPrice,
            currency: currency,
            expiresAt: invoice.expired_at
        });

    } catch (error) {
        console.error('‚ùå Error creating Cryptomus invoice:', error);
        return res.status(500).json({
            success: false,
            error: error.message || 'Failed to create invoice'
        });
    }
};
```

### 4.4 –û–±—Ä–∞–±–æ—Ç–∫–∞ Webhook

**–§–∞–π–ª**: `api/cryptomus/webhook.js`

```javascript
const cryptomusClient = require('../_lib/cryptomus/client');
const createOrderHandler = require('../esimgo/order');

// –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
const processedPayments = new Set();

function createMockReq(body = {}) {
    return {
        method: 'POST',
        body,
        headers: {},
        query: {}
    };
}

function createMockRes() {
    return {
        statusCode: 200,
        data: null,
        headers: {},
        status(code) {
            this.statusCode = code;
            return this;
        },
        json(payload) {
            this.data = payload;
            return this;
        },
        setHeader(key, value) {
            this.headers[key] = value;
        },
        end() {
            return this;
        }
    };
}

module.exports = async function handler(req, res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') {
        return res.status(200).end();
    }

    if (req.method !== 'POST') {
        return res.status(405).json({ success: false, error: 'Method not allowed' });
    }

    // –°—Ä–∞–∑—É –æ—Ç–≤–µ—á–∞–µ–º Cryptomus, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Ç–∞–π–º–∞—É—Ç–∞
    res.status(200).json({ success: true });

    try {
        const webhookData = req.body;

        console.log('üì• Cryptomus webhook received:', {
            type: webhookData.type,
            order_id: webhookData.order_id,
            status: webhookData.status,
            is_final: webhookData.is_final
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
        const signature = webhookData.sign;
        if (!cryptomusClient.verifyWebhookSignature(webhookData, signature)) {
            console.error('‚ùå Invalid webhook signature');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∏ –ø–ª–∞—Ç–µ–∂ –æ–ø–ª–∞—á–µ–Ω
        if (webhookData.status !== 'paid' || !webhookData.is_final) {
            console.log('‚ÑπÔ∏è Payment not final or not paid yet:', {
                status: webhookData.status,
                is_final: webhookData.is_final
            });
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
        const paymentId = webhookData.uuid || webhookData.order_id;
        if (processedPayments.has(paymentId)) {
            console.log('‚ö†Ô∏è Duplicate payment detected:', paymentId);
            return;
        }
        processedPayments.add(paymentId);

        // –ò–∑–≤–ª–µ–∫–∞–µ–º order_id –∏ –Ω–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑ on_hold
        const orderId = webhookData.order_id;
        if (!orderId || !orderId.startsWith('cryptomus_')) {
            console.error('‚ùå Invalid order_id in webhook');
            return;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        const fs = require('fs').promises;
        const path = require('path');
        const ORDERS_FILE = path.join(__dirname, '..', '..', 'data', 'orders.json');
        
        const ordersData = await fs.readFile(ORDERS_FILE, 'utf8');
        const allOrders = JSON.parse(ordersData);

        let existingOrder = null;
        let telegramUserId = null;

        // –ò—â–µ–º –∑–∞–∫–∞–∑ –ø–æ payment_session_id
        for (const userId in allOrders) {
            if (!Array.isArray(allOrders[userId])) continue;
            
            existingOrder = allOrders[userId].find(o => 
                o.payment_session_id === orderId ||
                o.orderReference === `pending_${orderId}`
            );
            
            if (existingOrder) {
                telegramUserId = userId;
                break;
            }
        }

        if (!existingOrder) {
            console.error('‚ùå Order not found:', orderId);
            return;
        }

        console.log('‚úÖ Found existing order:', {
            orderReference: existingOrder.orderReference,
            telegram_user_id: telegramUserId,
            iccid: existingOrder.iccid || 'NEW ESIM'
        });

        // –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ –≤ eSIM Go
        const orderReq = createMockReq({
            bundle_name: existingOrder.bundle_name,
            telegram_user_id: telegramUserId,
            telegram_username: existingOrder.telegram_username,
            iccid: existingOrder.iccid || null, // –¥–ª—è extend mode
            country_code: existingOrder.country_code,
            country_name: existingOrder.country_name,
            plan_id: existingOrder.plan_id,
            plan_type: existingOrder.plan_type,
            test_mode: false
        });

        const orderRes = createMockRes();

        await Promise.resolve(createOrderHandler(orderReq, orderRes));

        const success = orderRes.statusCode === 200 && orderRes.data && orderRes.data.success;

        if (success) {
            const orderData = orderRes.data.data;
            const orderRef = orderData.orderReference || orderData.reference;

            // –ü–æ–ª—É—á–∞–µ–º assignments (QR –∫–æ–¥, ICCID –∏ —Ç.–¥.)
            let assignments = orderData.assignments || null;
            
            if (!assignments && orderRef) {
                try {
                    const esimgoClient = require('../../_lib/esimgo/client');
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    assignments = await esimgoClient.getESIMAssignments(orderRef, 'qrCode');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to get assignments:', error.message);
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            const ordersHandler = require('../orders');
            const saveOrderReq = {
                telegram_user_id: telegramUserId,
                orderReference: orderRef,
                iccid: assignments?.iccid || null,
                matchingId: assignments?.matchingId || null,
                smdpAddress: assignments?.smdpAddress || null,
                qrCode: assignments?.qrCode || null,
                country_code: existingOrder.country_code,
                country_name: existingOrder.country_name,
                plan_id: existingOrder.plan_id,
                plan_type: existingOrder.plan_type,
                bundle_name: existingOrder.bundle_name,
                price: existingOrder.finalPrice || existingOrder.price,
                finalPrice: existingOrder.finalPrice || existingOrder.price,
                currency: existingOrder.currency || 'USD',
                status: assignments?.iccid ? 'completed' : 'on_hold',
                payment_method: 'cryptomus',
                payment_session_id: orderId,
                payment_status: 'succeeded',
                payment_confirmed: true,
                esim_issued: !!assignments?.iccid,
                createdAt: existingOrder.createdAt,
                updatedAt: new Date().toISOString()
            };

            const saveOrderRes = createMockRes();
            await Promise.resolve(ordersHandler(createMockReq(saveOrderReq), saveOrderRes));

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram
            if (assignments && (assignments.iccid || assignments.matchingId)) {
                const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN || process.env.BOT_TOKEN;
                if (BOT_TOKEN) {
                    let esimMessage = `üì± <b>Your eSIM data:</b>\n\n`;
                    if (assignments.iccid) {
                        esimMessage += `ICCID: <code>${assignments.iccid}</code>\n`;
                    }
                    if (assignments.matchingId) {
                        esimMessage += `Matching ID: <code>${assignments.matchingId}</code>\n`;
                    }
                    if (assignments.smdpAddress) {
                        esimMessage += `RSP URL: <code>${assignments.smdpAddress}</code>\n`;
                    }

                    try {
                        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                chat_id: telegramUserId,
                                text: esimMessage,
                                parse_mode: 'HTML'
                            })
                        });

                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º QR –∫–æ–¥ –µ—Å–ª–∏ –µ—Å—Ç—å
                        if (assignments.qrCode) {
                            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    chat_id: telegramUserId,
                                    photo: assignments.qrCode,
                                    caption: 'QR code for eSIM activation'
                                })
                            });
                        }
                    } catch (error) {
                        console.error('‚ùå Error sending message to user:', error);
                    }
                }
            }

            console.log('‚úÖ Cryptomus payment processed successfully:', {
                orderId,
                orderReference: orderRef,
                telegram_user_id: telegramUserId
            });
        } else {
            console.error('‚ùå Failed to create order in eSIM Go');
        }

    } catch (error) {
        console.error('‚ùå Error processing Cryptomus webhook:', error);
    }
};
```

### 4.5 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Frontend

**–§–∞–π–ª**: `public/checkout.js`

–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ Cryptomus:

```javascript
async function handlePurchaseWithCryptomus(auth) {
    if (!auth || !auth.id) {
        showCustomAlert('Please authorize first');
        return;
    }

    const selectedPlan = getSelectedPlan();
    if (!selectedPlan) {
        showCustomAlert('Please select a plan');
        return;
    }

    // –ù–∞—Ö–æ–¥–∏–º bundle_name
    const bundleName = await findBundleName(
        orderData.code,
        selectedPlan.dataAmount,
        selectedPlan.duration,
        selectedPlan.unlimited
    );

    if (!bundleName) {
        showCustomAlert('Plan not found. Please try again.');
        return;
    }

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É
    const costPrice = parseFloat(selectedPlan.price);
    const finalPrice = calculateFinalPrice(costPrice, 'cryptomus');

    // –°–æ–∑–¥–∞–µ–º invoice
    try {
        const response = await fetch('/api/cryptomus/create-invoice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                plan_id: selectedPlan.id,
                plan_type: selectedPlan.unlimited ? 'unlimited' : 'standard',
                bundle_name: bundleName,
                country_code: orderData.code,
                country_name: orderData.name,
                price: costPrice,
                currency: 'USD',
                telegram_user_id: auth.id,
                telegram_username: auth.username,
                iccid: orderData.extend && orderData.iccid ? orderData.iccid.trim() : undefined
            })
        });

        const result = await response.json();

        if (!result.success) {
            showCustomAlert(result.error || 'Failed to create payment');
            return;
        }

        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã Cryptomus
        window.location.href = result.invoiceUrl;

    } catch (error) {
        console.error('Error creating Cryptomus invoice:', error);
        showCustomAlert('Payment error. Please try again.');
    }
}
```

–û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `handlePurchase`:

```javascript
async function handlePurchase(auth) {
    if (selectedPaymentMethod === 'stars') {
        await handlePurchaseWithStars(auth);
    } else if (selectedPaymentMethod === 'cryptomus') {
        await handlePurchaseWithCryptomus(auth);
    } else {
        showCustomAlert('Please select a payment method');
    }
}
```

### 4.6 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–æ—É—Ç–æ–≤ –≤ server.js

```javascript
// Cryptomus routes
app.post('/api/cryptomus/create-invoice', require('./api/cryptomus/create-invoice'));
app.post('/api/cryptomus/webhook', require('./api/cryptomus/webhook'));
```

---

## üß™ –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 5.1 –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

1. **–ü–æ–∫—É–ø–∫–∞ eSIM —á–µ—Ä–µ–∑ Cryptomus**:
   - –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞
   - –í—ã–±–æ—Ä Cryptomus –∫–∞–∫ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
   - –°–æ–∑–¥–∞–Ω–∏–µ invoice
   - –û–ø–ª–∞—Ç–∞ (—Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤ eSIM Go
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è QR –∫–æ–¥–∞

2. **Extend —á–µ—Ä–µ–∑ Cryptomus**:
   - –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Extend
   - –í—ã–±–æ—Ä Cryptomus
   - –°–æ–∑–¥–∞–Ω–∏–µ invoice —Å iccid
   - –û–ø–ª–∞—Ç–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π eSIM

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**:
   - –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π invoice
   - –û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞
   - –ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å webhook
   - –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤ eSIM Go

### 5.2 –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ Cryptomus

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º Cryptomus (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω) –∏–ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ—à–µ–ª—å–∫–∏.

---

## üìù –≠—Ç–∞–ø 6: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 6.1 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cryptomus

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ https://cryptomus.com
2. –ü–æ–ª—É—á–∏—Ç—å `merchant_uuid` –∏ `api_key`
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook URL: `https://yourdomain.com/api/cryptomus/webhook`
4. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env`

### 6.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∫–∏

–î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Cryptomus –≤ –∞–¥–º–∏–Ω–∫–µ:
- –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã
- –ù–∞—Ü–µ–Ω–∫–∞ –¥–ª—è Cryptomus (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å Telegram Stars)

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –°–æ–∑–¥–∞—Ç—å `api/_lib/cryptomus/client.js`
- [ ] –°–æ–∑–¥–∞—Ç—å `api/cryptomus/create-invoice.js`
- [ ] –°–æ–∑–¥–∞—Ç—å `api/cryptomus/webhook.js`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ä–æ—É—Ç—ã –≤ `server.js`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `public/checkout.js` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Cryptomus
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ invoice
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å webhook
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Extend —Ä–µ–∂–∏–º
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –∞–¥–º–∏–Ω–∫—É –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Cryptomus
- [ ] –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook**: –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ø–∏—Å—å –æ—Ç Cryptomus
2. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –ü—Ä–æ–≤–µ—Ä—è—Ç—å –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ
4. **–¢–∞–π–º–∞—É—Ç—ã**: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è invoice
5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

1. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ invoice
2. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
3. –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–µ –∏ –Ω–µ—É—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
4. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook

---

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–ü–ª–∞–Ω –≥–æ—Ç–æ–≤. –ú–æ–∂–Ω–æ –ø—Ä–∏—Å—Ç—É–ø–∞—Ç—å –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ —ç—Ç–∞–ø–∞–º.
