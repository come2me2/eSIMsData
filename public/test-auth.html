<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>Telegram Auth Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F2F2F7;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #000;
        }
        
        .subtitle {
            color: #8E8E93;
            font-size: 14px;
            margin-bottom: 24px;
        }
        
        .status {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            font-weight: 500;
        }
        
        .status.success {
            background: #D1F2EB;
            color: #00695C;
            border: 1px solid #4CAF50;
        }
        
        .status.error {
            background: #FFEBEE;
            color: #B71C1C;
            border: 1px solid #F44336;
        }
        
        .status.warning {
            background: #FFF3E0;
            color: #E65100;
            border: 1px solid #FF9800;
        }
        
        .section {
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #000;
        }
        
        .data-item {
            background: #F2F2F7;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .data-label {
            color: #8E8E93;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .data-value {
            color: #000;
            font-weight: 500;
            word-break: break-all;
        }
        
        .button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
        }
        
        .button:hover {
            background: #0051D5;
        }
        
        .button:active {
            background: #0040A8;
        }
        
        .json-view {
            background: #1E1E1E;
            color: #D4D4D4;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 16px;
            color: #007AFF;
            text-decoration: none;
            font-size: 14px;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê –ù–∞–∑–∞–¥</a>
        <h1>üîê –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram</h1>
        <p class="subtitle">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Telegram SDK –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>
        
        <div id="statusContainer"></div>
        
        <div class="section">
            <div class="section-title">–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</div>
            <div id="authStatus"></div>
        </div>
        
        <div class="section">
            <div class="section-title">–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <div id="userData"></div>
        </div>
        
        <div class="section">
            <div class="section-title">Telegram WebApp –¥–∞–Ω–Ω—ã–µ</div>
            <div id="webAppData"></div>
        </div>
        
        <div class="section">
            <div class="section-title">üîê –°–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (signature/hash)</div>
            <div id="validationStatus"></div>
            <button class="button" style="background: #34C759; margin-top: 12px;" onclick="validateOnServer()">üîí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</button>
        </div>
        
        <div class="section">
            <div class="section-title">–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON)</div>
            <div id="jsonData" class="json-view"></div>
        </div>
        
        <button class="button" onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>
    
    <script src="telegram-auth.js"></script>
    <script>
        function updateStatus() {
            const auth = window.telegramAuth;
            const statusContainer = document.getElementById('statusContainer');
            const authStatus = document.getElementById('authStatus');
            const userData = document.getElementById('userData');
            const webAppData = document.getElementById('webAppData');
            const jsonData = document.getElementById('jsonData');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ SDK
            const sdkAvailable = !!window.Telegram?.WebApp;
            const authAvailable = !!auth;
            const isAuthenticated = auth?.isAuthenticated() || false;
            
            // –°—Ç–∞—Ç—É—Å
            let statusHTML = '';
            if (!sdkAvailable) {
                statusHTML = '<div class="status error">‚ùå Telegram SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram!</div>';
            } else if (!authAvailable) {
                statusHTML = '<div class="status error">‚ùå telegram-auth.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>';
            } else if (!isAuthenticated) {
                statusHTML = '<div class="status warning">‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram WebApp!</div>';
            } else {
                statusHTML = '<div class="status success">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! Telegram ID –ø–æ–ª—É—á–µ–Ω.</div>';
            }
            statusContainer.innerHTML = statusHTML;
            
            // –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            authStatus.innerHTML = `
                <div class="data-item">
                    <div class="data-label">SDK –∑–∞–≥—Ä—É–∂–µ–Ω</div>
                    <div class="data-value">${sdkAvailable ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">telegram-auth.js –∑–∞–≥—Ä—É–∂–µ–Ω</div>
                    <div class="data-value">${authAvailable ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
                    <div class="data-value">${isAuthenticated ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</div>
                </div>
            `;
            
            // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (auth && isAuthenticated) {
                const user = auth.getUserData();
                userData.innerHTML = `
                    <div class="data-item">
                        <div class="data-label">Telegram ID</div>
                        <div class="data-value">${user.id || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">–ò–º—è</div>
                        <div class="data-value">${user.name || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">–ò–º—è (first_name)</div>
                        <div class="data-value">${user.first_name || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">–§–∞–º–∏–ª–∏—è (last_name)</div>
                        <div class="data-value">${user.last_name || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Username</div>
                        <div class="data-value">${user.username ? '@' + user.username : 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">–Ø–∑—ã–∫</div>
                        <div class="data-value">${user.language || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</div>
                        <div class="data-value">${user.photo ? '‚úÖ –ï—Å—Ç—å' : '‚ùå –ù–µ—Ç'}</div>
                    </div>
                `;
            } else {
                userData.innerHTML = '<div class="data-item"><div class="data-value" style="color: #8E8E93;">–î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram WebApp.</div></div>';
            }
            
            // WebApp –¥–∞–Ω–Ω—ã–µ
            if (window.Telegram?.WebApp) {
                const tg = window.Telegram.WebApp;
                webAppData.innerHTML = `
                    <div class="data-item">
                        <div class="data-label">–í–µ—Ä—Å–∏—è</div>
                        <div class="data-value">${tg.version || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</div>
                        <div class="data-value">${tg.platform || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">–¢–µ–º–∞</div>
                        <div class="data-value">${tg.colorScheme || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">initData –¥–æ—Å—Ç—É–ø–µ–Ω</div>
                        <div class="data-value">${tg.initData ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</div>
                    </div>
                `;
            } else {
                webAppData.innerHTML = '<div class="data-item"><div class="data-value" style="color: #8E8E93;">Telegram SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div></div>';
            }
            
            // JSON –¥–∞–Ω–Ω—ã–µ
            const allData = {
                sdk: {
                    available: sdkAvailable,
                    version: window.Telegram?.WebApp?.version,
                    platform: window.Telegram?.WebApp?.platform
                },
                auth: {
                    available: authAvailable,
                    authenticated: isAuthenticated,
                    userData: auth ? auth.getUserData() : null,
                    initDataUnsafe: window.Telegram?.WebApp?.initDataUnsafe || null
                }
            };
            
            jsonData.textContent = JSON.stringify(allData, null, 2);
        }
        
        function refreshData() {
            updateStatus();
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
        }
        
        // –°–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ signature/hash
        async function validateOnServer() {
            const validationStatus = document.getElementById('validationStatus');
            validationStatus.innerHTML = '<div class="data-item"><div class="data-value">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</div></div>';
            
            const auth = window.telegramAuth;
            
            if (!auth || !auth.getInitData()) {
                validationStatus.innerHTML = `
                    <div class="status error">‚ùå initData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>
                    <div class="data-item">
                        <div class="data-label">–ü—Ä–∏—á–∏–Ω–∞</div>
                        <div class="data-value">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram Mini App</div>
                    </div>
                `;
                return;
            }
            
            try {
                const result = await auth.validateOnServer('/api/validate-telegram');
                
                if (result.valid) {
                    const methodIcon = result.method === 'signature' ? 'üîê' : 'üîë';
                    const methodName = result.method === 'signature' 
                        ? 'Ed25519 Signature (–Ω–æ–≤—ã–π)' 
                        : 'HMAC-SHA256 Hash (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π)';
                    
                    validationStatus.innerHTML = `
                        <div class="status success">‚úÖ –î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã! –ü–æ–¥–ø–∏—Å—å –≤–µ—Ä–Ω–∞.</div>
                        <div class="data-item">
                            <div class="data-label">–ú–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
                            <div class="data-value">${methodIcon} ${methodName}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">–ê–ª–≥–æ—Ä–∏—Ç–º</div>
                            <div class="data-value">${result.algorithm || 'N/A'}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">User ID (–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω)</div>
                            <div class="data-value">${result.user?.id || 'N/A'}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Username</div>
                            <div class="data-value">${result.user?.username ? '@' + result.user.username : 'N/A'}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">auth_date –∞–∫—Ç—É–∞–ª–µ–Ω</div>
                            <div class="data-value">${result.auth_date_valid ? '‚úÖ –î–∞ (–º–µ–Ω–µ–µ 24—á)' : '‚ö†Ô∏è –ù–µ—Ç (—Å—Ç–∞—Ä—à–µ 24—á)'}</div>
                        </div>
                    `;
                    
                    if (window.Telegram?.WebApp) {
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    }
                } else {
                    validationStatus.innerHTML = `
                        <div class="status error">‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞</div>
                        <div class="data-item">
                            <div class="data-label">–û—à–∏–±–∫–∞</div>
                            <div class="data-value">${result.error || 'Unknown error'}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">–ú–µ—Ç–æ–¥</div>
                            <div class="data-value">${result.method || 'N/A'}</div>
                        </div>
                    `;
                    
                    if (window.Telegram?.WebApp) {
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º JSON
                document.getElementById('jsonData').textContent = JSON.stringify({
                    validation: result,
                    initData_length: auth.getInitData()?.length || 0
                }, null, 2);
                
            } catch (error) {
                validationStatus.innerHTML = `
                    <div class="status error">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</div>
                    <div class="data-item">
                        <div class="data-label">–û—à–∏–±–∫–∞</div>
                        <div class="data-value">${error.message}</div>
                    </div>
                `;
                
                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                }
            }
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ telegram-auth.js
            setTimeout(updateStatus, 500);
        });
        
    </script>
</body>
</html>

