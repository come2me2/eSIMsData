# Пример расчета наценок для Telegram Stars

## 📊 Исходные данные

- **Себестоимость eSIM** (от eSIM GO): **$2.26**
- **Базовая маржа** (из админки): **29%** (множитель 1.29)
- **Дополнительная маржа Stars** (из админки): **5%** (множитель 1.05)
- **Комиссия Telegram**: **25%**
- **Курс Stars**: **1 Star = $0.013**

---

## 🔄 Поток расчета

### 1️⃣ API возвращает цену с базовой маржой

```
Себестоимость = $2.26
Базовая маржа = 1.29 (29%)
───────────────────────────────
Цена на checkout = $2.26 × 1.29 = $2.92
```

**Код:** `api/esimgo/plans.js` → `applyMarkup()`

---

### 2️⃣ Пользователь выбирает способ оплаты "Telegram Stars"

На странице checkout применяется дополнительная маржа:

```
Цена с базовой маржой = $2.92
Дополнительная маржа Stars = 1.05 (5%)
───────────────────────────────────────
Финальная цена для пользователя = $2.92 × 1.05 = $3.07
```

**Код:** `public/checkout.js` → `updateTotalPrice()`

✅ **Пользователь видит на checkout: $3.07**

---

### 3️⃣ Клиент вычисляет себестоимость перед отправкой

Перед созданием инвойса, клиент вычисляет себестоимость:

```
Цена с базовой маржой = $2.92
Базовая маржа = 1.29
────────────────────────────────
Себестоимость = $2.92 / 1.29 = $2.26
```

**Код:** `public/checkout.js` → `initiateStarsPayment()`

```javascript
const costPrice = priceValue / baseMarkup; // $2.92 / 1.29 = $2.26
```

---

### 4️⃣ Сервер рассчитывает количество Stars

Сервер получает себестоимость и применяет обе наценки заново:

```
Себестоимость = $2.26
Базовая маржа = 1.29 (из админки)
Маржа Stars = 1.05 (из админки)
────────────────────────────────────────
Финальная цена = $2.26 × 1.29 × 1.05 = $3.06
```

**Код:** `api/telegram/stars/create-invoice.js`

```javascript
const settings = await loadMarkupSettings();
const baseMarkup = settings.markup.base; // 1.29
const starsMarkup = settings.paymentMethods.telegramStars.markupMultiplier; // 1.05

const finalPrice = costPrice * baseMarkup * starsMarkup;
// $2.26 × 1.29 × 1.05 = $3.06
```

---

### 5️⃣ Расчет количества Stars

```
Финальная цена = $3.06
Комиссия Telegram = 25% (множитель 0.75)
Курс Stars = $0.013
────────────────────────────────────────────
Stars = $3.06 / (1 - 0.25) / $0.013
Stars = $3.06 / 0.75 / $0.013
Stars = 314 Stars
```

**Формула:**
```javascript
const amountStars = Math.ceil(
    finalPrice / (1 - STARS_TELEGRAM_FEE) / STARS_RATE
);
// Math.ceil($3.06 / 0.75 / 0.013) = 314 Stars
```

---

## ✅ Проверка расчета

### Что получает Telegram от пользователя:
```
314 Stars × $0.013 = $4.08
```

### Что получаем мы после комиссии Telegram (25%):
```
$4.08 × (1 - 0.25) = $4.08 × 0.75 = $3.06 ✅
```

### Проверка наценок:
```
Себестоимость = $2.26
Наша выручка = $3.06
────────────────────────────
Чистая прибыль = $3.06 - $2.26 = $0.80
Маржа = $0.80 / $2.26 = 35.4%
```

Эта маржа складывается из:
- Базовая маржа: 29%
- Дополнительная маржа Stars: 5%
- Общая маржа: (1.29 × 1.05 - 1) = 35.45% ✅

---

## 📝 Резюме

| Этап | Значение |
|------|----------|
| Себестоимость eSIM | $2.26 |
| Цена на checkout (с базовой маржой 29%) | $2.92 |
| Финальная цена (с маржой Stars 5%) | $3.06 |
| Количество Stars | 314 |
| Пользователь платит (в USD) | $4.08 |
| Мы получаем после комиссии TG | $3.06 |
| Чистая прибыль | $0.80 (35.4%) |

---

## 🎯 Ключевые моменты

1. ✅ **На checkout показывается финальная цена** с обеими наценками: $3.06
2. ✅ **В формулу Stars передается себестоимость**: $2.26
3. ✅ **Формула применяет обе наценки заново**: базовую (29%) + Stars (5%)
4. ✅ **Результат правильный**: пользователь платит ровно то, что видит на checkout
5. ✅ **Все наценки управляются из админ-панели** - нет hardcoded значений

---

## 🔧 Настройка в админ-панели

### Базовая маржа (применяется ко всем товарам):
- Путь: Админка → Settings → Наценка к товарам
- Значение: **1.29** (29%)

### Дополнительная маржа для Telegram Stars:
- Путь: Админка → Settings → Способы оплаты → Telegram Stars
- Значение: **1.05** (5%)

### Дополнительная маржа для других способов оплаты:
- **Криптовалюты**: 1.0 (0% - без наценки)
- **Банковские карты**: 1.1 (10%)

---

## ⚠️ Важно

Если вы измените наценки в админ-панели, все изменения применятся **автоматически**:
- На странице checkout обновится финальная цена
- В формуле Stars будут использованы новые значения
- Пересчет произойдет в реальном времени без изменения кода

