# Инструкция по кэшированию данных планов

## Текущая система кэширования

### 1. Серверное кэширование (Vercel)
- **TTL**: 24 часа
- **Тип**: In-memory кэш на сервере
- **Автоматическое обновление**: Через cron job (1 раз в сутки)

### 2. Клиентское кэширование (localStorage)
- **TTL**: 24 часа
- **Тип**: localStorage в браузере пользователя
- **Преимущества**: Мгновенная загрузка при повторном открытии

## Как предзаполнить кэш

### Вариант 1: Через API endpoint (рекомендуется)

```bash
# Предзаполнить весь кэш
curl "https://esim-data.vercel.app/api/cache/prefill?secret=esimsdata11"

# Или только планы
curl "https://esim-data.vercel.app/api/cache/refresh?secret=esimsdata11&type=plans"
```

### Вариант 2: Через скрипт (локально)

```bash
# Установите переменные окружения в .env
ESIMGO_API_KEY=your_api_key

# Запустите скрипт
npm run prefill-cache
```

### Вариант 3: Автоматически через Cron

Кэш автоматически обновляется 1 раз в сутки через Vercel Cron Jobs (если настроено).

## Что кэшируется

1. **Список стран** (`countries:all`)
   - TTL: 24 часа
   - Обновляется редко

2. **Global планы** (`plans:global`)
   - TTL: 24 часа
   - Включает стандартные и безлимитные планы
   - Список из 106 стран

3. **Region планы** (`plans:region:Africa`, `plans:region:Asia`, и т.д.)
   - TTL: 24 часа
   - Для каждого региона отдельно

4. **Local планы** (`plans:local:US`, `plans:local:GB`, и т.д.)
   - TTL: 24 часа
   - Для каждой страны отдельно

## Проверка кэша

### Проверить, что данные в кэше:

```bash
# Проверить Global планы
curl "https://esim-data.vercel.app/api/esimgo/plans?category=global"

# В ответе должно быть: "source": "cache" в meta
```

### Очистить кэш:

```bash
# Очистить весь кэш
curl "https://esim-data.vercel.app/api/cache/refresh?secret=esimsdata11&type=all"

# Очистить только планы
curl "https://esim-data.vercel.app/api/cache/refresh?secret=esimsdata11&type=plans"
```

## Производительность

### Без кэша:
- Загрузка Global планов: 5-10 секунд
- Загрузка Region планов: 3-5 секунд
- Загрузка Local планов: 2-4 секунды

### С серверным кэшем:
- Загрузка Global планов: 0.5-1 секунда
- Загрузка Region планов: 0.3-0.8 секунды
- Загрузка Local планов: 0.2-0.5 секунды

### С серверным + клиентским кэшем:
- Загрузка Global планов: **мгновенно** (< 50ms)
- Загрузка Region планов: **мгновенно** (< 50ms)
- Загрузка Local планов: **мгновенно** (< 50ms)

## Рекомендации

1. **После деплоя**: Запустите предзаполнение кэша
2. **После обновления данных**: Очистите и перезаполните кэш
3. **Мониторинг**: Проверяйте логи Vercel на наличие ошибок кэширования

## Переменные окружения

Убедитесь, что установлены:
- `ESIMGO_API_KEY` - API ключ eSIM Go
- `CACHE_REFRESH_SECRET` - Секретный ключ для защиты endpoints (по умолчанию: `change-me-in-production`)

