# –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ Contabo

## üìã –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤

#### –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ invoice (Telegram Stars)
**–§–∞–π–ª:** `api/telegram/stars/create-invoice.js` (—Å—Ç—Ä–æ–∫–∏ 404-459)

- ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–∫–∞–∑ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `on_hold`
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–π `orderReference: pending_${invoiceId}`
- ‚úÖ `payment_status: 'pending'`
- ‚úÖ `payment_method: 'telegram_stars'`
- ‚úÖ `payment_session_id: invoiceId`
- ‚úÖ –¢–∞–π–º–∞—É—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è: `expires_at` = —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è + 5 –º–∏–Ω—É—Ç
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç)

**–ö–æ–¥:**
```javascript
status: 'on_hold',
orderReference: `pending_${invoiceId}`,
payment_status: 'pending',
expires_at: new Date(Date.now() + 5 * 60 * 1000).toISOString()
```

#### –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –≤ –ë–î
**–§–∞–π–ª:** `api/orders.js` (—Å—Ç—Ä–æ–∫–∏ 140-317)

- ‚úÖ –°—Ç–∞—Ç—É—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `status = 'completed'` (—Å—Ç—Ä–æ–∫–∞ 157)
- ‚úÖ –ù–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ API
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `payment_confirmed` –∏ `esim_issued` (—Å—Ç—Ä–æ–∫–∏ 211-212)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª–µ–π —Å—Ç–∞—Ç—É—Å–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 255-263)

---

### 2. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞

#### –°—Ç–∞—Ç—É—Å `on_hold`
**–£—Å–ª–æ–≤–∏—è:**
- –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ invoice
- –ü–ª–∞—Ç–µ–∂ –µ—â–µ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
- eSIM –µ—â–µ –Ω–µ –≤—ã–¥–∞–Ω–∞

**–ü–æ–ª—è:**
- `status: 'on_hold'`
- `payment_status: 'pending'`
- `payment_confirmed: false` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `esim_issued: false` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `expires_at: <–≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è + —Ç–∞–π–º–∞—É—Ç>`

---

### 3. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ

#### Webhook Telegram Stars
**–§–∞–π–ª:** `api/telegram/stars/webhook.js` (—Å—Ç—Ä–æ–∫–∏ 438-483)

**–õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:**
```javascript
let finalStatus = 'on_hold';
if (success && hasEsim) {
    finalStatus = 'completed';
} else if (success && !hasEsim) {
    finalStatus = 'on_hold';
    console.warn('‚ö†Ô∏è Payment confirmed but eSIM not issued yet. Keeping status on_hold.');
}
```

**–£—Å–ª–æ–≤–∏—è –¥–ª—è `completed`:**
- ‚úÖ –ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω (`success === true`)
- ‚úÖ eSIM –≤—ã–¥–∞–Ω–∞ (`hasEsim === true`)

**–£—Å–ª–æ–≤–∏—è –¥–ª—è `on_hold`:**
- ‚úÖ –ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, –Ω–æ eSIM –µ—â–µ –Ω–µ –≤—ã–¥–∞–Ω–∞

**–û–±–Ω–æ–≤–ª—è–µ–º—ã–µ –ø–æ–ª—è –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ:**
- `status: finalStatus` (—Å—Ç—Ä–æ–∫–∞ 468)
- `payment_status: 'succeeded'` (—Å—Ç—Ä–æ–∫–∞ 478)
- `payment_confirmed: true` (—Å—Ç—Ä–æ–∫–∞ 479)
- `esim_issued: hasEsim` (—Å—Ç—Ä–æ–∫–∞ 480)
- `esim_checked_at: new Date().toISOString()` (—Å—Ç—Ä–æ–∫–∞ 481)
- `expires_at: null` (—Å—Ç—Ä–æ–∫–∞ 482) - —É–±–∏—Ä–∞–µ—Ç—Å—è —Ç–∞–π–º–∞—É—Ç
- `orderReference` –∑–∞–º–µ–Ω—è–µ—Ç—Å—è —Å `pending_${invoiceId}` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∏–∑ eSIM Go (—Å—Ç—Ä–æ–∫–∞ 450-452)

---

### 4. –¢–∞–π–º–∞—É—Ç—ã

#### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤
**–§–∞–π–ª:** `scripts/check-order-timeouts.js` (—Å—Ç—Ä–æ–∫–∏ 19-24)

```javascript
const TIMEOUTS = {
    telegram_stars: 5 * 60 * 1000,      // 5 –º–∏–Ω—É—Ç
    stripe: 20 * 60 * 1000,              // 20 –º–∏–Ω—É—Ç
    cryptomus: 60 * 60 * 1000           // 60 –º–∏–Ω—É—Ç
};
```

#### –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
**–§–∞–π–ª:** `scripts/check-order-timeouts.js` (—Å—Ç—Ä–æ–∫–∏ 44-150)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
1. –ü—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –≤—Å–µ–º –∑–∞–∫–∞–∑–∞–º —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `on_hold`
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `expires_at`:
   - –ï—Å–ª–∏ `expires_at < now()` ‚Üí —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `status: 'canceled'`
   - –ï—Å–ª–∏ `expires_at` –Ω–µ—Ç ‚Üí –≤—ã—á–∏—Å–ª—è–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ `payment_method` –∏ `createdAt`
3. –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑:
   - `status: 'canceled'`
   - `canceled_reason: 'timeout'`
   - `updatedAt: new Date().toISOString()`

#### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚úÖ –°–∫—Ä–∏–ø—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: `scripts/check-order-timeouts.js`
- ‚úÖ –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚ùå Cron job –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚ùå PM2 scheduler –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚ùå –°–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# Cron –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
crontab -l | grep timeout
# (–ø—É—Å—Ç–æ)

# PM2 job –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
pm2 list | grep timeout
# (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)
```

---

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

### 1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤

**–í–∞—Ä–∏–∞–Ω—Ç 1: Cron job (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab
* * * * * cd /var/www/esimsdata && node scripts/check-order-timeouts.js >> /var/log/order-timeouts.log 2>&1
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: PM2 scheduler**
```bash
# –°–æ–∑–¥–∞—Ç—å ecosystem.config.js —Å scheduler
pm2 start ecosystem.config.js
```

**–í–∞—Ä–∏–∞–Ω—Ç 3: PM2 cron**
```bash
pm2 start scripts/check-order-timeouts.js --cron "*/1 * * * *" --name "check-order-timeouts"
```

---

## üìä –°–≤–æ–¥–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤

| –°—Ç–∞—Ç—É—Å | –ö–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è | –£—Å–ª–æ–≤–∏—è |
|--------|----------------------|---------|
| `on_hold` | –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ invoice | –ü–ª–∞—Ç–µ–∂ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω |
| `on_hold` | –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –±–µ–∑ eSIM | –ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, –Ω–æ eSIM –Ω–µ –≤—ã–¥–∞–Ω–∞ |
| `completed` | –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ —Å eSIM | –ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ò eSIM –≤—ã–¥–∞–Ω–∞ |
| `canceled` | –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ | `expires_at < now()` |
| `failed` | –ü—Ä–∏ –æ—à–∏–±–∫–µ | (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é) |

---

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ `on_hold` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ invoice
2. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ `expires_at`
3. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ webhook –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è eSIM –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π `completed`
5. ‚úÖ –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

## ‚ùå –ß—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. ‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ (cron/PM2 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)
2. ‚ùå –ó–∞–∫–∞–∑—ã —Å –∏—Å—Ç–µ–∫—à–∏–º —Ç–∞–π–º–∞—É—Ç–æ–º –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. ‚ùå –°—Ç–∞—Ç—É—Å `failed` –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–°—Ä–æ—á–Ω–æ:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron job –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
2. **–í–∞–∂–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
3. **–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å `failed` –¥–ª—è –æ—à–∏–±–æ–∫ –ø–ª–∞—Ç–µ–∂–∞/–∑–∞–∫–∞–∑–∞
