# Обновление кэша тарифов

## Что было сделано

1. ✅ **Создан скрипт для проверки цен** (`scripts/verify-tariff-prices.js`)
   - Проверяет цены всех тарифов из esimgo API
   - Показывает диапазон цен и примеры для каждой страны
   - Проверяет Global тарифы

2. ✅ **Изменен endpoint `/api/esimgo/plans`**
   - Теперь пользователи видят **ТОЛЬКО предзаполненный кэш**
   - `forceRefresh` доступен только с секретным ключом (для админов)
   - Если кэш пуст, выводится предупреждение

3. ✅ **Создан скрипт для обновления кэша** (`scripts/update-tariff-cache.js`)
   - Вызывает endpoint `/api/cache/prefill` для обновления всех тарифов
   - Показывает детальную статистику обновления

## Как использовать

### 1. Проверка цен тарифов

Перед обновлением кэша рекомендуется проверить текущие цены:

```bash
node scripts/verify-tariff-prices.js
```

Этот скрипт:
- Проверяет цены для популярных стран
- Проверяет Global тарифы
- Показывает диапазон цен и примеры

### 2. Обновление кэша тарифов

После проверки цен обновите кэш:

```bash
# Локально (если сервер запущен на localhost:3000)
node scripts/update-tariff-cache.js

# На продакшене (укажите URL и секрет)
node scripts/update-tariff-cache.js https://your-app.vercel.app your-secret-key
```

Или через curl:

```bash
curl "https://your-app.vercel.app/api/cache/prefill?secret=your-secret-key"
```

### 3. Переменные окружения

Убедитесь, что установлены переменные окружения:

```bash
ESIMGO_API_KEY=your_esimgo_api_key
CACHE_REFRESH_SECRET=your_secret_key  # Для защиты endpoint prefill
```

## Важно

- **Пользователи видят только кэш** - после обновления кэша все пользователи увидят актуальные цены
- **Кэш обновляется через `/api/cache/prefill`** - этот endpoint защищен секретным ключом
- **TTL кэша: 24 часа** - кэш автоматически обновляется раз в сутки (если настроен cron)
- **Наценки применяются динамически** - кэш хранит цены без наценки, наценка применяется при возврате данных

## Структура кэша

Кэш хранит данные по ключам:
- `countries:all` - список всех стран
- `plans:global` - Global тарифы
- `plans:region:{region}` - региональные тарифы (Africa, Asia, Europe и т.д.)
- `plans:local:{countryCode}` - локальные тарифы для каждой страны

## Автоматическое обновление

Для автоматического обновления кэша настройте cron job:

```bash
# Обновление кэша каждый день в 3:00 AM
0 3 * * * curl "https://your-app.vercel.app/api/cache/prefill?secret=your-secret-key"
```

Или используйте Vercel Cron Jobs (если настроено).


